# ============================================================================
# NIGHT: Charge SolarFlow from grid when today's PV forecast is low
# Plan anytime (sets helper), act only 02:00â€“07:00 (touches inverter)
# Helper used by automation 11: input_boolean.solarflow_night_charge_planned
# ============================================================================

- id: solarflow_night_charge_low_pv_forecast
  alias: "SolarFlow â€“ Plan/Charge on Low PV Forecast (plan anytime; charge 02:00â€“07:00)"
  description: >
    Plans grid charge by setting input_boolean.solarflow_night_charge_planned anytime.
    Actually charges SolarFlow from the grid at 600 W only during 02:00â€“07:00 when
    PV forecast is low and SoC is below the configured limit.
  mode: restart

  trigger:
    - platform: time_pattern
      minutes: "/30"
      id: planning_periodic

    # Smart: force a plan refresh shortly before 11's 01:59:30 cutoff
    - platform: time
      at: "01:50:00"
      id: pre_cutoff_plan

    - platform: state
      entity_id: sensor.solarflow_800_pro_electric_level
      for: "00:00:20"
      id: soc_change

    - platform: time
      at: "02:00:00"
      id: window_start

    - platform: time
      at: "07:00:00"
      id: window_end_check

    - platform: homeassistant
      event: start
      id: ha_startup

  # No global time condition: we want the helper to update before 02:00.
  condition:
    - condition: template
      value_template: >
        {{ states('sensor.solarflow_800_pro_electric_level')
           not in ['unknown','unavailable'] }}

    - condition: template
      value_template: >
        {{ states('number.solarflow_800_pro_output_limit')
           not in ['unknown','unavailable']
           and states('number.solarflow_800_pro_input_limit')
           not in ['unknown','unavailable'] }}

  action:
    # Clear the plan flag at the window end
    - if:
        - condition: trigger
          id: window_end_check
      then:
        - service: input_boolean.turn_off
          target:
            entity_id: input_boolean.solarflow_night_charge_planned
        - stop: "Window ended; cleared planned flag"

    - variables:
        soc: "{{ states('sensor.solarflow_800_pro_electric_level') | float(0) }}"
        last_charge: "{{ states('input_number.solarflow_charge_last') | float(0) | int }}"
        charge_power: 600
        low_pv_soc_limit: "{{ states('input_number.solarflow_low_pv_soc_limit') | float(45) }}"

        # Use today's forecast (because after midnight it's already 'today')
        pv_today_kwh: "{{ states('sensor.energy_production_today') | float(0) }}"
        pv_threshold_kwh: "{{ states('input_number.solarflow_pv_threshold_kwh') | float(5) }}"

        pv_forecast_available: >-
          {{ states('sensor.energy_production_today')
             not in ['unknown','unavailable','none',''] }}

        # Decision: should we charge tonight due to low PV forecast?
        should_charge_low_pv: >-
          {{ pv_forecast_available
             and (pv_today_kwh < pv_threshold_kwh)
             and soc < 70
             and (soc < low_pv_soc_limit or last_charge > 0) }}

    # Update the helper used by automation 11.
    # Safety: only update if forecast is available; otherwise keep previous value.
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ pv_forecast_available }}"
          sequence:
            - service: "input_boolean.turn_{{ 'on' if should_charge_low_pv else 'off' }}"
              target:
                entity_id: input_boolean.solarflow_night_charge_planned
      default: []

    - choose:
        # A) Plan-only outside the window (donâ€™t touch inverter)
        - conditions:
            - condition: time
              before: "02:00:00"
          sequence:
            - stop: "Planning only (before 02:00)"

        - conditions:
            - condition: time
              after: "07:00:00"
          sequence:
            - stop: "Planning only (after 07:00)"

        # B) In-window charge when planned
        - conditions:
            - condition: time
              after: "02:00:00"
              before: "07:00:00"
            - condition: template
              value_template: "{{ should_charge_low_pv }}"
          sequence:
            - service: select.select_option
              target:
                entity_id: select.solarflow_800_pro_ac_mode
              data:
                option: "input"

            - service: number.set_value
              target:
                entity_id: number.solarflow_800_pro_output_limit
              data:
                value: 0

            - service: number.set_value
              target:
                entity_id: number.solarflow_800_pro_input_limit
              data:
                value: "{{ charge_power }}"

            - service: input_number.set_value
              target:
                entity_id: input_number.solarflow_discharge_last
              data:
                value: 0

            - service: input_number.set_value
              target:
                entity_id: input_number.solarflow_charge_last
              data:
                value: "{{ charge_power }}"

            - service: system_log.write
              data:
                level: debug
                logger: solarflow_grid_control
                message: >
                  ðŸŒ™ CHARGE (LOW PV): {{ charge_power }}W | soc={{ soc }}%
                  | pv_today={{ pv_today_kwh }}kWh | threshold={{ pv_threshold_kwh }}kWh
                  | planned={{ is_state('input_boolean.solarflow_night_charge_planned','on') }}

      default:
        # In-window but not charging: if we were charging before, stop/idle
        - condition: time
          after: "02:00:00"
          before: "07:00:00"
        - condition: template
          value_template: "{{ (last_charge | int) != 0 }}"

        - service: select.select_option
          target:
            entity_id: select.solarflow_800_pro_ac_mode
          data:
            option: "output"

        - service: number.set_value
          target:
            entity_id:
              - number.solarflow_800_pro_output_limit
              - number.solarflow_800_pro_input_limit
          data:
            value: 0

        - service: input_number.set_value
          target:
            entity_id:
              - input_number.solarflow_discharge_last
              - input_number.solarflow_charge_last
          data:
            value: 0

        - service: system_log.write
          data:
            level: debug
            logger: solarflow_grid_control
            message: >
              ðŸ›‘ WINDOW IDLE: soc={{ soc }}% (conditions not met)
              | planned={{ is_state('input_boolean.solarflow_night_charge_planned','on') }}
