# ============================================================================
# DAY: Bidirectional 100W Grid-Zero (08:00 - 23:00)
# ============================================================================

- id: solarflow_day_grid_zero_step_100w
  alias: "SolarFlow – Daytime 100W Grid-Zero (Charge+Discharge)"
  description: >
    Keep Shelly Phase A around 0W using 100W steps.
    Charges when exporting, discharges when importing.
  mode: restart

  trigger:
    # Import side (want discharge)
    - platform: numeric_state
      entity_id: sensor.shelly_phase_a_power
      above: 150          # importing >150W
      for: "00:00:10"
      id: import_high

    # Export side (want charge)
    - platform: numeric_state
      entity_id: sensor.shelly_phase_a_power
      below: -150         # exporting >150W
      for: "00:00:10"
      id: export_high

    # Periodic reevaluation
    - platform: time_pattern
      minutes: "/3"
      id: periodic

    # At day start
    - platform: time
      at: "08:00:00"
      id: day_start

    # After HA restart
    - platform: homeassistant
      event: start
      id: ha_startup

  condition:
    # Daytime only
    - condition: time
      after: "08:00:00"
      before: "23:00:00"

    # Entities available
    - condition: template
      value_template: >
        {{ states('sensor.solarflow_800_pro_electric_level') not in ['unknown','unavailable'] }}
    - condition: template
      value_template: >
        {{ states('sensor.shelly_phase_a_power') not in ['unknown','unavailable'] }}
    - condition: template
      value_template: >
        {{ states('number.solarflow_800_pro_output_limit') not in ['unknown','unavailable']
           and states('number.solarflow_800_pro_input_limit') not in ['unknown','unavailable'] }}

  action:
    - variables:
        grid: "{{ states('sensor.shelly_phase_a_power') | float(0) }}"
        soc: "{{ states('sensor.solarflow_800_pro_electric_level') | float(50) }}"
        last_discharge: "{{ states('input_number.solarflow_discharge_last') | float(0) | int }}"
        last_charge: "{{ states('input_number.solarflow_charge_last') | float(0) | int }}"

        soc_discharge_min: "{{ states('input_number.solarflow_soc_discharge_min') | float(25) | int }}"
        soc_charge_max: "{{ states('input_number.solarflow_soc_charge_max') | float(90) | int }}"
        step_size: 100
        max_discharge: 800
        max_charge: 1000
        min_delta: 80      # threshold to actually send a command

        # -------------------------
        # IMPORT → DISCHARGE steps
        # -------------------------
        import_step: >-
          {% if soc <= soc_discharge_min %}
            0
          {% elif grid > 850 %}
            8
          {% elif grid > 750 %}
            7
          {% elif grid > 650 %}
            6
          {% elif grid > 550 %}
            5
          {% elif grid > 450 %}
            4
          {% elif grid > 350 %}
            3
          {% elif grid > 250 %}
            2
          {% elif grid > 150 %}
            1
          {% else %}
            0
          {% endif %}

        import_power: >-
          {% set p = import_step | int * step_size %}
          {% if p > max_discharge %} {{ max_discharge }} {% else %} {{ p }} {% endif %}

        target_discharge: >-
          {% set ld = last_discharge | int %}
          {% set rbp = import_power | int %}
          {% set g = grid %}

          {% if rbp > ld %}
            {{ rbp }}          {# step up when band says higher #}
          {% elif rbp < ld and g > 100 %}
            {{ ld }}           {# still importing enough, keep for stability #}
          {% elif rbp < ld %}
            {{ rbp }}          {# import fell, step down #}
          {% else %}
            {{ ld }}           {# unchanged #}
          {% endif %}

        # -------------------------
        # EXPORT → CHARGE steps
        # -------------------------
        export_step: >-
          {% if soc >= soc_charge_max %}
            0
          {% elif grid < -850 %}
            8
          {% elif grid < -750 %}
            7
          {% elif grid < -650 %}
            6
          {% elif grid < -550 %}
            5
          {% elif grid < -450 %}
            4
          {% elif grid < -350 %}
            3
          {% elif grid < -250 %}
            2
          {% elif grid < -150 %}
            1
          {% else %}
            0
          {% endif %}

        export_power: >-
          {% set p = export_step | int * step_size %}
          {% if p > max_charge %} {{ max_charge }} {% else %} {{ p }} {% endif %}

        target_charge: >-
          {% set lc = last_charge | int %}
          {% set rbp = export_power | int %}
          {% set g = grid %}

          {% if rbp > lc %}
            {{ rbp }}          {# step up when surplus grows #}
          {% elif rbp < lc and g < -50 %}
            {{ lc }}           {# still exporting, keep current charge #}
          {% elif rbp < lc %}
            {{ rbp }}          {# surplus shrank, step down #}
          {% else %}
            {{ lc }}           {# unchanged #}
          {% endif %}

        # Enforce mutual exclusivity: if importing, prefer discharge;
        # if exporting, prefer charge; near zero -> both 0.
        final_discharge: >-
          {% if grid > 150 %}
            {{ target_discharge | int }}
          {% else %}
            0
          {% endif %}
        final_charge: >-
          {% if grid < -150 %}
            {{ target_charge | int }}
          {% else %}
            0
          {% endif %}

        delta_dis: "{{ (final_discharge | int) - (last_discharge | int) | abs }}"
        delta_ch:  "{{ (final_charge    | int) - (last_charge    | int) | abs }}"

    - choose:
        # BRANCH A: DISCHARGE
        - conditions:
            - condition: template
              value_template: "{{ final_discharge | int > 0 }}"
            - condition: template
              value_template: "{{ delta_dis | int >= min_delta or (last_discharge | int) == 0 }}"
          sequence:
            # Ensure AC mode is OUTPUT so discharging actually works
            - service: select.select_option
              target:
                entity_id: select.solarflow_800_pro_ac_mode
              data:
                option: "output"

            - service: number.set_value
              target:
                entity_id: number.solarflow_800_pro_output_limit
              data:
                value: "{{ final_discharge | int }}"
              continue_on_error: false

            - service: number.set_value
              target:
                entity_id: number.solarflow_800_pro_input_limit
              data:
                value: 0
              continue_on_error: false

            - service: input_number.set_value
              target:
                entity_id: input_number.solarflow_discharge_last
              data:
                value: "{{ final_discharge | int }}"

            - service: input_number.set_value
              target:
                entity_id: input_number.solarflow_charge_last
              data:
                value: 0

            - service: system_log.write
              data:
                level: info
                logger: solarflow_grid_control
                message: >
                  "STEP100 DISCH: grid={{ grid }}W, soc={{ soc }}%, new={{ final_discharge }}W,
                   last={{ last_discharge }}W, delta={{ delta_dis }}W, trigger={{ trigger.id }}"

        # BRANCH B: CHARGE
        - conditions:
            - condition: template
              value_template: "{{ final_charge | int > 0 }}"
            - condition: template
              value_template: "{{ delta_ch | int >= min_delta or (last_charge | int) == 0 }}"
          sequence:
            # Ensure AC mode is INPUT so charging works
            - service: select.select_option
              target:
                entity_id: select.solarflow_800_pro_ac_mode
              data:
                option: "input"

            - service: number.set_value
              target:
                entity_id: number.solarflow_800_pro_input_limit
              data:
                value: "{{ final_charge | int }}"
              continue_on_error: false

            - service: number.set_value
              target:
                entity_id: number.solarflow_800_pro_output_limit
              data:
                value: 0
              continue_on_error: false

            - service: input_number.set_value
              target:
                entity_id: input_number.solarflow_charge_last
              data:
                value: "{{ final_charge | int }}"

            - service: input_number.set_value
              target:
                entity_id: input_number.solarflow_discharge_last
              data:
                value: 0

            - service: system_log.write
              data:
                level: info
                logger: solarflow_grid_control
                message: >
                  "STEP100 CHARGE: grid={{ grid }}W, soc={{ soc }}%, new={{ final_charge }}W,
                   last={{ last_charge }}W, delta={{ delta_ch }}W, trigger={{ trigger.id }}"

      # DEFAULT: IDLE (both 0) – only when both targets are zero
      default:
        - condition: template
          value_template: >
            {{ (final_discharge | int) == 0
               and (final_charge | int) == 0
               and ((last_discharge | int) != 0 or (last_charge | int) != 0) }}

        - service: number.set_value
          target:
            entity_id:
              - number.solarflow_800_pro_output_limit
              - number.solarflow_800_pro_input_limit
          data:
            value: 0
          continue_on_error: false

        - service: input_number.set_value
          target:
            entity_id:
              - input_number.solarflow_discharge_last
              - input_number.solarflow_charge_last
          data:
            value: 0

        - service: system_log.write
          data:
            level: info
            logger: solarflow_grid_control
            message: >
              "STEP100 IDLE: grid={{ grid }}W, soc={{ soc }}%, trigger={{ trigger.id }}"

