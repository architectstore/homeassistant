# ===========================================================================
# AUTOMATION 1: Night Idle (23:00 â€“ 08:00)
# ===========================================================================
# Ensures SolarFlow stays completely idle at night.
# No charge, no discharge, no setpoint changes.
#
# Triggers:
#   - Every 10 minutes (safety enforcement during night)
#   - HA startup (recover from unexpected state)
#   - 23:00 hard edge (switch to night mode immediately)
#
# Note: Removed 08:00 triggerâ€”day automation handles the transition.
# ===========================================================================
- id: solarflow_night_idle
  alias: "SolarFlow â€“ Night Idle (23:00â€“08:00)"
  description: "Keep SolarFlow completely idle during night hours"
  mode: single
  max_exceeded: silent
  trigger:
    # Safety enforcement every 10 minutes
    - platform: time_pattern
      minutes: "/10"
      id: periodic_check

    # Recover from unexpected state on HA restart
    - platform: homeassistant
      event: start
      id: ha_startup

    # Hard edge at night start (23:00)
    - platform: time
      at: "23:00:00"
      id: night_start

  condition:
    # Active only between 23:00 and 08:00
    # Using OR is the standard HA approach for midnight-spanning windows
    - condition: or
      conditions:
        - condition: time
          after: "23:00:00"
        - condition: time
          before: "08:00:00"

  action:
    # Set both limits to 0 (no charge, no discharge)
    - service: number.set_value
      target:
        entity_id:
          - number.solarflow_discharge_limit
          - number.solarflow_ac_charge_limit
      data:
        value: 0
      continue_on_error: false

    # Sync helper state to avoid false deltas when day automation starts
    - service: input_number.set_value
      target:
        entity_id:
          - input_number.solarflow_discharge_last
          - input_number.solarflow_charge_last
      data:
        value: 0
      continue_on_error: false

    # Optional: Log night enforcement
    - service: system_log.write
      data:
        level: debug
        logger: solarflow_grid_control
        message: >
          ðŸŒ™ Night idle enforced. Discharge=0W, Charge=0W.
          Trigger: {{ trigger.id }}


# ===========================================================================
# AUTOMATION 2: Daytime Grid-Zero Control (08:00 â€“ 23:00)
# ===========================================================================
# Dynamically adjusts discharge and AC charge to keep phase A grid power
# at Â±50 W (deadband). Respects SoC bounds and device limits.
#
# Core Logic:
#   - Grid > +50 W and SoC > 25%  â†’ Discharge to reduce import
#   - Grid < -50 W and SoC < 90%  â†’ Charge to reduce export
#   - |Grid| â‰¤ 50 W               â†’ Idle (no charge/discharge)
#
# Hysteresis:
#   - Â±50 W deadband (hard threshold)
#   - Optional min_delta (soft threshold on consecutive commands)
#
# Safety:
#   - Trigger debounce: 10 sec (avoid flapping on noise)
#   - Safety tick: every 3 minutes (catch missed updates)
#   - Error handling: continue_on_error: false (fail safe)
#   - SoC check: guard against unavailable sensor
# ===========================================================================
- id: solarflow_day_grid_zero
  alias: "SolarFlow â€“ Daytime Grid-Zero (Phase A)"
  description: >
    Maintain grid power near zero on phase A by adjusting SolarFlow
    discharge and AC charge limits.
  mode: single
  max_exceeded: silent
  trigger:
    # React to grid power changes (with 10 sec debounce)
    - platform: state
      entity_id: sensor.shelly_phase_a_power
      for: "00:00:10"
      id: grid_change

    # React to SoC changes (with 20 sec debounce)
    - platform: state
      entity_id: sensor.eoa1nhn3n259185_electriclevel
      for: "00:00:20"
      id: soc_change

    # Safety tick every 3 minutes (was: every 30 sec = excessive)
    # If grid/SoC sensors stall, this ensures enforcement
    - platform: time_pattern
      minutes: "/3"
      id: safety_tick

  condition:
    # Active only between 08:00 and 23:00 (day window)
    - condition: time
      after: "08:00:00"
      before: "23:00:00"

    # Guard: SoC sensor must be available (not unknown/unavailable)
    # Fail safe: if offline, block automation to prevent 0% SoC assumptions
    - condition: template
      value_template: >
        {{ states('sensor.eoa1nhn3n259185_electriclevel')
            not in ['unknown', 'unavailable'] }}

  action:
    # ======================================================================
    # SECTION A: CONFIGURABLE CONSTANTS & STATE READS
    # ======================================================================
    # All thresholds and limits are defined here for easy adjustment.
    # ======================================================================
    - variables:
        # Current sensor readings
        grid: "{{ states('sensor.shelly_phase_a_power') | float(0) }}"
        soc: "{{ states('sensor.eoa1nhn3n259185_electriclevel') | float(50) }}"

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # HYSTERESIS & CONTROL THRESHOLDS
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Deadband around 0 W grid power.
        # If |grid| â‰¤ deadband, SolarFlow stays idle.
        deadband: 50

        # SoC bounds to prevent over-discharge / over-charge
        soc_discharge_min: 25     # Discharge only if SoC > 25 %
        soc_charge_max: 90        # Charge only if SoC < 90 %

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # DEVICE POWER LIMITS (W)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        max_discharge: 800        # SolarFlow max discharge power
        max_charge: 1000          # SolarFlow max AC charge power

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # OPTIONAL HYSTERESIS ON SETPOINTS
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Extra delta threshold: only send new setpoint if change >= min_delta.
        # Set to 0 to disable (rely on Â±50 W deadband only).
        # Recommended: 0 or 50 W.
        min_delta: "{{ states('input_number.solarflow_min_delta') | float(50) }}"

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # LAST SETPOINTS SENT (from helpers, used for delta comparison)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        last_discharge: "{{ states('input_number.solarflow_discharge_last') | float(0) }}"
        last_charge: "{{ states('input_number.solarflow_charge_last') | float(0) }}"

        # ======================================================================
        # SECTION B: TARGET POWER CALCULATION
        # ======================================================================
        # Based on grid power and SoC, calculate desired discharge/charge.
        #
        # Sign convention:
        #   grid > 0  = importing from grid (load > solar)
        #   grid < 0  = exporting to grid (solar > load)
        #
        # Strategy:
        #   1. Discharge when importing (grid > deadband) and SoC allows (SoC > min)
        #   2. Charge when exporting (grid < -deadband) and SoC allows (SoC < max)
        #   3. Default: idle (both 0)
        # ======================================================================

        # Target discharge power (W)
        # If grid import > deadband and SoC > discharge_min, discharge to offset
        target_discharge: >
          {% if grid > deadband and soc > soc_discharge_min %}
            {% set p = grid - deadband %}
            {% set p = [p, max_discharge] | min %}
            {{ (p | round(0)) | int }}
          {% else %}
            0
          {% endif %}

        # Target AC charge power (W)
        # If grid export > deadband and SoC < charge_max, charge to offset
        target_charge: >
          {% if grid < -deadband and soc < soc_charge_max %}
            {% set p = (grid | abs) - deadband %}
            {% set p = [p, max_charge] | min %}
            {{ (p | round(0)) | int }}
          {% else %}
            0
          {% endif %}

    # ======================================================================
    # SECTION C: DECISION TREE (CHOOSE BRANCHES)
    # ======================================================================
    # Three mutually exclusive branches:
    #   1. Discharge: if target_discharge > 0
    #   2. Charge: if target_charge > 0
    #   3. Idle: default (both 0)
    #
    # Each branch checks delta hysteresis before sending.
    # ======================================================================
    - choose:
        # ===================================================================
        # BRANCH 1: DISCHARGE (Grid import > deadband, SoC > min)
        # ===================================================================
        - conditions:
            - condition: template
              value_template: "{{ target_discharge | float(0) > 0 }}"

          sequence:
            # Check delta hysteresis: only send if change is significant
            # OR if transitioning from non-zero to zero
            - condition: template
              value_template: >
                {% set new = target_discharge | float(0) %}
                {% set old = last_discharge | float(0) %}
                {% set delta = (new - old) | abs %}
                {{ delta >= min_delta or (new == 0 and old != 0) }}

            # Send discharge limit to SolarFlow
            - service: number.set_value
              target:
                entity_id: number.solarflow_discharge_limit
              data:
                value: "{{ target_discharge }}"
              continue_on_error: false

            # Ensure AC charge is off
            - service: number.set_value
              target:
                entity_id: number.solarflow_ac_charge_limit
              data:
                value: 0
              continue_on_error: false

            # Sync helper state for next delta comparison
            - service: input_number.set_value
              target:
                entity_id: input_number.solarflow_discharge_last
              data:
                value: "{{ target_discharge }}"
              continue_on_error: false

            - service: input_number.set_value
              target:
                entity_id: input_number.solarflow_charge_last
              data:
                value: 0
              continue_on_error: false

            # Log for debugging
            - service: system_log.write
              data:
                level: debug
                logger: solarflow_grid_control
                message: >
                  â¬‡ï¸ DISCHARGE: grid={{ grid }}W, soc={{ soc }}%,
                  target={{ target_discharge }}W (delta from {{ last_discharge }}W)

        # ===================================================================
        # BRANCH 2: CHARGE (Grid export > deadband, SoC < max)
        # ===================================================================
        - conditions:
            - condition: template
              value_template: "{{ target_charge | float(0) > 0 }}"

          sequence:
            # Check delta hysteresis
            - condition: template
              value_template: >
                {% set new = target_charge | float(0) %}
                {% set old = last_charge | float(0) %}
                {% set delta = (new - old) | abs %}
                {{ delta >= min_delta or (new == 0 and old != 0) }}

            # Send AC charge limit to SolarFlow
            - service: number.set_value
              target:
                entity_id: number.solarflow_ac_charge_limit
              data:
                value: "{{ target_charge }}"
              continue_on_error: false

            # Ensure discharge is off
            - service: number.set_value
              target:
                entity_id: number.solarflow_discharge_limit
              data:
                value: 0
              continue_on_error: false

            # Sync helper state for next delta comparison
            - service: input_number.set_value
              target:
                entity_id: input_number.solarflow_charge_last
              data:
                value: "{{ target_charge }}"
              continue_on_error: false

            - service: input_number.set_value
              target:
                entity_id: input_number.solarflow_discharge_last
              data:
                value: 0
              continue_on_error: false

            # Log for debugging
            - service: system_log.write
              data:
                level: debug
                logger: solarflow_grid_control
                message: >
                  â¬†ï¸ CHARGE: grid={{ grid }}W, soc={{ soc }}%,
                  target={{ target_charge }}W (delta from {{ last_charge }}W)

      # ===================================================================
      # BRANCH 3: IDLE (Default)
      # ===================================================================
      # If neither discharge nor charge is active, force both limits to 0.
      # Only send zeros if something was previously non-zero (avoid spam).
      # ===================================================================
      default:
        # Skip if already idle
        - condition: template
          value_template: >
            {{ last_discharge != 0 or last_charge != 0 }}

        # Set both limits to 0
        - service: number.set_value
          target:
            entity_id:
              - number.solarflow_discharge_limit
              - number.solarflow_ac_charge_limit
          data:
            value: 0
          continue_on_error: false

        # Sync helper state
        - service: input_number.set_value
          target:
            entity_id:
              - input_number.solarflow_discharge_last
              - input_number.solarflow_charge_last
          data:
            value: 0
          continue_on_error: false

        # Log for debugging
        - service: system_log.write
          data:
            level: debug
            logger: solarflow_grid_control
            message: >
              â¸ï¸ IDLE: grid={{ grid }}W (deadband Â±{{ deadband }}W),
              soc={{ soc }}% (bounds: {{ soc_discharge_min }}â€“{{ soc_charge_max }}%)


# ===========================================================================
# OPTIONAL: Debug Automation â€“ Track SolarFlow Setpoint Changes
# ===========================================================================
# Logs every command sent to SolarFlow for analysis and troubleshooting.
# Disable in production if verbose logging causes HA overhead.
# ===========================================================================
- id: solarflow_debug_command_timing
  alias: "SolarFlow â€“ Debug Command Timing"
  description: "Track when discharge/charge limits are changed"
  mode: parallel
  max: 10
  trigger:
    - platform: state
      entity_id:
        - number.solarflow_discharge_limit
        - number.solarflow_ac_charge_limit
      id: limit_changed
  action:
    - service: system_log.write
      data:
        level: info
        logger: solarflow_grid_control
        message: >
          ðŸ“Š {{ trigger.entity_id | regex_findall_index('(discharge|charge)') }}
          limit changed: {{ trigger.from_state.state }}W â†’ {{ trigger.to_state.state }}W
