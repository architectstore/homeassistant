# ============================================================================
# DAY: 100W step controller with memory (08:00 - 23:00)
# ============================================================================

- id: solarflow_day_step_100w
  alias: "SolarFlow – Daytime 100W Step Control"
  description: >
    Charge in 100W steps starting at 150W surplus. Uses last_charge helper
    to prevent oscillation after each step. Fast emergency stop only on
    large import (e.g. toaster), not on small imports.
  mode: restart

  trigger:
    # FAST: large import -> stop charging quickly (toaster, big load)
    - platform: numeric_state
      entity_id: sensor.shelly_phase_a_power
      above: 500            # importing > 500W
      for: "00:00:05"       # sustained for 5 seconds
      id: fast_import

    # FAST: large export -> increase charge quickly
    - platform: numeric_state
      entity_id: sensor.shelly_phase_a_power
      below: -400           # exporting > 400W
      for: "00:00:10"
      id: fast_export

    # NORMAL: periodic reevaluation every 3 minutes
    - platform: time_pattern
      minutes: "/3"
      id: periodic

    # At day start
    - platform: time
      at: "08:00:00"
      id: day_start

    # After HA restart
    - platform: homeassistant
      event: start
      id: ha_startup

  condition:
    # Active only during day window
    - condition: time
      after: "08:00:00"
      before: "23:00:00"

    # Entities must be available
    - condition: template
      value_template: >
        {{ states('sensor.solarflow_800_pro_electric_level') not in ['unknown','unavailable'] }}
    - condition: template
      value_template: >
        {{ states('sensor.shelly_phase_a_power') not in ['unknown','unavailable'] }}
    - condition: template
      value_template: >
        {{ states('number.solarflow_800_pro_input_limit') not in ['unknown','unavailable'] }}

  action:
    - variables:
        grid: "{{ states('sensor.shelly_phase_a_power') | float(0) }}"
        soc: "{{ states('sensor.solarflow_800_pro_electric_level') | float(50) }}"
        last_charge: "{{ states('input_number.solarflow_charge_last') | float(0) | int }}"
        soc_charge_max: "{{ states('input_number.solarflow_soc_charge_max') | float(90) | int }}"

        # Calculate raw band (what grid alone suggests, ignoring current state)
        # Grid sign: + import, - export
        raw_band_step: >-
          {% if soc >= soc_charge_max %}
            0
          {% elif grid < -850 %}
            8
          {% elif grid < -750 %}
            7
          {% elif grid < -650 %}
            6
          {% elif grid < -550 %}
            5
          {% elif grid < -450 %}
            4
          {% elif grid < -350 %}
            3
          {% elif grid < -250 %}
            2
          {% elif grid < -150 %}
            1
          {% else %}
            0
          {% endif %}

        raw_band_power: "{{ raw_band_step | int * 100 }}"

        # Decide actual desired power using hysteresis and last_charge
        desired_power: >-
          {% set lc = last_charge | int %}
          {% set rbp = raw_band_power | int %}
          {% set g = grid %}

          {# CASE 1: Stop charging if SoC maxed #}
          {% if soc >= soc_charge_max %}
            0

          {# CASE 2: Raw band suggests HIGHER power than current → increase step #}
          {% elif rbp > lc %}
            {{ rbp }}

          {# CASE 3: Raw band suggests LOWER power but we're still exporting a bit → keep current #}
          {% elif rbp < lc and g < -50 %}
            {{ lc }}

          {# CASE 4: Raw band lower and grid near zero or importing lightly → step down #}
          {% elif rbp < lc %}
            {{ rbp }}

          {# CASE 5: Band equals current → keep #}
          {% else %}
            {{ lc }}
          {% endif %}

        # Size of change vs last command
        delta_ch: "{{ (desired_power | int) - (last_charge | int) | abs }}"

    - choose:
        # Only send command if change is at least 80W (allows 100W steps through)
        - conditions:
            - condition: template
              value_template: "{{ delta_ch >= 80 }}"
          sequence:
            # Set AC charge limit
            - service: number.set_value
              target:
                entity_id: number.solarflow_800_pro_input_limit
              data:
                value: "{{ desired_power | int }}"
              continue_on_error: false

            # Ensure discharge is off
            - service: number.set_value
              target:
                entity_id: number.solarflow_800_pro_output_limit
              data:
                value: 0
              continue_on_error: false

            # Update helpers
            - service: input_number.set_value
              target:
                entity_id: input_number.solarflow_charge_last
              data:
                value: "{{ desired_power | int }}"

            - service: input_number.set_value
              target:
                entity_id: input_number.solarflow_discharge_last
              data:
                value: 0

            - service: system_log.write
              data:
                level: info
                logger: solarflow_grid_control
                message: >
                  "STEP100: grid={{ grid }}W, soc={{ soc }}%, last={{ last_charge }}W,
                   raw_band={{ raw_band_power }}W, desired={{ desired_power }}W,
                   delta={{ delta_ch }}W, trigger={{ trigger.id }}"

      default:
        # No meaningful change → do nothing
        - service: system_log.write
          data:
            level: debug
            logger: solarflow_grid_control
            message: >
              "STEP100: no change - grid={{ grid }}W, soc={{ soc }}%, last={{ last_charge }}W,
               desired={{ desired_power }}W, delta={{ delta_ch }}W, trigger={{ trigger.id }}"
