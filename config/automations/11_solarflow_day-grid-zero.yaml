# ============================================================================
# GRID-ZERO: Bidirectional 100W steps (07:00* - 03:00) with SoC lock after 22:00
# *Starts at 07:00 only if SoC >= 75%, otherwise starts at 08:00 as usual.
# ============================================================================
#
# Changes merged:
# - Add 07:00 trigger so it can start immediately.
# - Window opens at 07:00 instead of 08:00.
# - Extra condition: during 07:00–08:00 require SoC >= 75; after 08:00 always allowed.
# - Optional safety automation: at 07:00 if SoC < 75 force IDLE (limits=0) so nothing is left running.
#
# ============================================================================

# ----------------------------------------------------------------------------
# MAIN GRID-ZERO CONTROLLER
# ----------------------------------------------------------------------------
- id: solarflow_day_grid_zero_step_100w
  alias: "SolarFlow – Grid-Zero 100W Steps (07:00–03:00; 07:00 requires SoC>=75)"
  description: >
    Keep Shelly Phase A around 0W using step control.
    Runs 07:00–03:00 (cross-midnight). Between 07:00–08:00 it runs only if SoC >= 75%.
    After 08:00 it runs regardless of SoC. After 22:00, forces IDLE if SoC is low.
  mode: restart
  trace:
    stored_traces: 720  # ~12h if it triggers every minute

  trigger:
    # Import side (want discharge)
    - platform: numeric_state
      entity_id: sensor.shelly_phase_a_power_smoothed
      above: 75
      for: "00:00:05"
      id: import_high

    # Export side (want charge)
    - platform: numeric_state
      entity_id: sensor.shelly_phase_a_power_smoothed
      below: -75
      for: "00:00:05"
      id: export_high

    # Periodic reevaluation
    - platform: time_pattern
      minutes: "/1"
      id: periodic

    # Early start evaluation
    - platform: time
      at: "07:00:00"
      id: early_start_0700

    # Normal day start
    - platform: time
      at: "08:00:00"
      id: day_start

    # Enforce lock check exactly at 22:00
    - platform: time
      at: "22:00:00"
      id: lock_check_2200

    # After HA restart
    - platform: homeassistant
      event: start
      id: ha_startup

  condition:
    # Window 07:00 -> 03:00 (cross-midnight)
    - condition: template
      value_template: >
        {% set t = now().strftime('%H:%M:%S') %}
        {{ (t >= '07:00:00') or (t < '03:00:00') }}

    # Gate ONLY the early hour 07:00–08:00: require SoC >= 75
    # After 08:00 always allowed (regardless of SoC).
    - condition: template
      value_template: >
        {% set t = now().strftime('%H:%M:%S') %}
        {% set soc = states('sensor.solarflow_800_pro_electric_level') | float(0) %}
        {{ (t >= '08:00:00') or (t < '07:00:00') or (soc >= 75) }}

    # Entities available
    - condition: template
      value_template: >
        {{ states('sensor.solarflow_800_pro_electric_level') not in ['unknown','unavailable'] }}

    - condition: template
      value_template: >
        {{ states('sensor.shelly_phase_a_power_smoothed') not in ['unknown','unavailable'] }}

    - condition: template
      value_template: >
        {{ states('number.solarflow_800_pro_output_limit') not in ['unknown','unavailable']
           and states('number.solarflow_800_pro_input_limit') not in ['unknown','unavailable'] }}

  action:
    - variables:
        grid: "{{ states('sensor.shelly_phase_a_power_smoothed') | float(0) }}"
        soc: "{{ states('sensor.solarflow_800_pro_electric_level') | float(50) }}"
        last_discharge: "{{ states('input_number.solarflow_discharge_last') | float(0) | int }}"
        last_charge: "{{ states('input_number.solarflow_charge_last') | float(0) | int }}"
        soc_discharge_min: "{{ states('input_number.solarflow_soc_discharge_min') | float(25) | int }}"
        soc_charge_max: "{{ states('input_number.solarflow_soc_charge_max') | float(90) | int }}"

        # --- policy knobs ---
        evening_soc_min: 50

        # After 22:00, if SoC is low, force idle (inclusive: <=)
        after_22_and_low_soc: >-
          {% set t = now().strftime('%H:%M:%S') %}
          {{ (t >= '22:00:00') and (soc <= evening_soc_min) }}

        # --- tuning ---
        step_size: 50
        max_discharge: 800
        max_charge: 1000
        min_delta: 40

        # -------------------------
        # IMPORT → DISCHARGE target
        # -------------------------
        target_discharge: >-
          {% set ld = last_discharge | int %}
          {% set g = grid | float %}
          {% set soc_min = soc_discharge_min %}
          {% set step = step_size | int %}
          {% set maxd = max_discharge | int %}
          {% if soc <= soc_min %}
            0
          {% else %}
            {% set load_est = g + ld %}
            {% set ideal = load_est - 50 %}
            {% if ideal < 0 %}{% set ideal = 0 %}{% endif %}
            {% if ideal > maxd %}{% set ideal = maxd %}{% endif %}
            {% if g > 800 %}
              {{ ideal }}
            {% elif g > 400 %}
              {% set max_jump = step * 3 %}
              {% if ideal > ld + max_jump %}
                {{ ld + max_jump }}
              {% elif ideal < ld - max_jump %}
                {{ ld - max_jump }}
              {% else %}
                {{ ideal }}
              {% endif %}
            {% else %}
              {% if ideal > ld + step %}
                {{ ld + step }}
              {% elif ideal < ld - step %}
                {{ ld - step }}
              {% else %}
                {{ ideal }}
              {% endif %}
            {% endif %}
          {% endif %}

        # -------------------------
        # EXPORT → CHARGE steps
        # -------------------------
        export_step: >-
          {% if soc >= soc_charge_max %}
            0
          {% elif grid < -950 %}
            20
          {% elif grid < -850 %}
            18
          {% elif grid < -750 %}
            16
          {% elif grid < -650 %}
            14
          {% elif grid < -550 %}
            12
          {% elif grid < -450 %}
            10
          {% elif grid < -350 %}
            8
          {% elif grid < -250 %}
            6
          {% elif grid < -150 %}
            4
          {% elif grid < -100 %}
            2
          {% else %}
            0
          {% endif %}

        export_power: >-
          {% set p = (export_step | int) * step_size %}
          {% if p > max_charge %}
            {{ max_charge }}
          {% else %}
            {{ p }}
          {% endif %}

        target_charge: >-
          {% set lc = last_charge | int %}
          {% set rbp = export_power | int %}
          {% set g = grid | float %}
          {% if rbp > lc %}
            {{ rbp }}
          {% elif g < -250 %}
            {{ lc + (step_size * 2) }}
          {% elif g < -150 %}
            {{ lc + step_size }}
          {% elif rbp < lc and g < -80 %}
            {{ lc }}
          {% elif rbp < lc %}
            {{ rbp }}
          {% else %}
            {{ lc }}
          {% endif %}

        final_discharge: >-
          {% set g = grid | float %}
          {% set td = target_discharge | int %}
          {% set ld = last_discharge | int %}
          {% if g > 120 %}
            {{ td }}
          {% elif g < -50 %}
            0
          {% else %}
            {{ ld }}
          {% endif %}

        final_charge: >-
          {% set g = grid | float %}
          {% set lc = last_charge | int %}
          {% set tc = target_charge | int %}
          {% set sun_state = states('sun.sun') %}
          {% set can_daycharge = (sun_state == 'above_horizon') %}
          {% set max_ch = max_charge | int %}
          {% set step = step_size | int %}
          {% if g <= -80 and can_daycharge %}
            {% set fc = tc %}
          {% elif -80 < g < 80 %}
            {% set fc = lc %}
          {% elif 80 <= g <= 250 %}
            {% set reduce = (g | int) %}
            {% set raw = lc - reduce %}
            {% if raw < 0 %}
              {% set fc = 0 %}
            {% else %}
              {% set steps = (raw // step) | int %}
              {% set fc = (steps * step) | int %}
            {% endif %}
          {% else %}
            {% set fc = 0 %}
          {% endif %}
          {% if fc < 0 %}
            0
          {% elif fc > max_ch %}
            {{ max_ch }}
          {% else %}
            {{ fc }}
          {% endif %}

        delta_dis: "{{ ((final_discharge | int) - (last_discharge | int)) | abs }}"
        delta_ch: "{{ ((final_charge | int) - (last_charge | int)) | abs }}"

    - choose:
        # ============================================================
        # RULE: After 22:00 and SoC <= 50% => force idle (no control)
        # ============================================================
        - conditions:
            - condition: template
              value_template: "{{ after_22_and_low_soc }}"
          sequence:
            - service: number.set_value
              target:
                entity_id:
                  - number.solarflow_800_pro_output_limit
                  - number.solarflow_800_pro_input_limit
              data:
                value: 0
              continue_on_error: false

            - service: input_number.set_value
              target:
                entity_id:
                  - input_number.solarflow_discharge_last
                  - input_number.solarflow_charge_last
              data:
                value: 0

            - service: system_log.write
              data:
                level: info
                logger: solarflow_grid_control
                message: >
                  "STEP100 LOCKED: after 22:00 and SoC={{ soc }}% <= {{ evening_soc_min }}% -> IDLE,
                  grid={{ grid }}W, trigger={{ trigger.id }}"

            - stop: "Locked after 22:00 due to low SoC"

        # BRANCH A: DISCHARGE
        - conditions:
            - condition: template
              value_template: "{{ final_discharge | int > 0 }}"
            - condition: template
              value_template: "{{ delta_dis | int >= min_delta or (last_discharge | int) == 0 }}"
          sequence:
            - service: select.select_option
              target:
                entity_id: select.solarflow_800_pro_ac_mode
              data:
                option: "output"

            - service: number.set_value
              target:
                entity_id: number.solarflow_800_pro_output_limit
              data:
                value: "{{ final_discharge | int }}"
              continue_on_error: false

            - service: number.set_value
              target:
                entity_id: number.solarflow_800_pro_input_limit
              data:
                value: 0
              continue_on_error: false

            - service: input_number.set_value
              target:
                entity_id: input_number.solarflow_discharge_last
              data:
                value: "{{ final_discharge | int }}"

            - service: input_number.set_value
              target:
                entity_id: input_number.solarflow_charge_last
              data:
                value: 0

            - service: system_log.write
              data:
                level: info
                logger: solarflow_grid_control
                message: >
                  "STEP100 DISCH: grid={{ grid }}W, soc={{ soc }}%, new={{ final_discharge }}W,
                  last={{ last_discharge }}W, delta={{ delta_dis }}W, trigger={{ trigger.id }}"

        # BRANCH B: CHARGE
        - conditions:
            - condition: template
              value_template: "{{ final_charge | int > 0 }}"
            - condition: template
              value_template: "{{ delta_ch | int >= min_delta or (last_charge | int) == 0 }}"
            - condition: sun
              after: sunrise
              after_offset: "00:30:00"
            - condition: sun
              before: sunset
              before_offset: "-00:30:00"
          sequence:
            - service: select.select_option
              target:
                entity_id: select.solarflow_800_pro_ac_mode
              data:
                option: "input"

            - service: number.set_value
              target:
                entity_id: number.solarflow_800_pro_input_limit
              data:
                value: "{{ final_charge | int }}"
              continue_on_error: false

            - service: number.set_value
              target:
                entity_id: number.solarflow_800_pro_output_limit
              data:
                value: 0
              continue_on_error: false

            - service: input_number.set_value
              target:
                entity_id: input_number.solarflow_charge_last
              data:
                value: "{{ final_charge | int }}"

            - service: input_number.set_value
              target:
                entity_id: input_number.solarflow_discharge_last
              data:
                value: 0

            - service: system_log.write
              data:
                level: info
                logger: solarflow_grid_control
                message: >
                  "STEP100 CHARGE: grid={{ grid }}W, soc={{ soc }}%, new={{ final_charge }}W,
                  last={{ last_charge }}W, delta={{ delta_ch }}W, trigger={{ trigger.id }}"

      default:
        # DEFAULT: IDLE (both 0) – only when both targets are zero
        - condition: template
          value_template: >
            {{ (final_discharge | int) == 0
               and (final_charge | int) == 0
               and ((last_discharge | int) != 0 or (last_charge | int) != 0) }}

        - service: number.set_value
          target:
            entity_id:
              - number.solarflow_800_pro_output_limit
              - number.solarflow_800_pro_input_limit
          data:
            value: 0
          continue_on_error: false

        - service: input_number.set_value
          target:
            entity_id:
              - input_number.solarflow_discharge_last
              - input_number.solarflow_charge_last
          data:
            value: 0

        - service: system_log.write
          data:
            level: info
            logger: solarflow_grid_control
            message: >
              "STEP100 IDLE: grid={{ grid }}W, soc={{ soc }}%, trigger={{ trigger.id }}"

# ----------------------------------------------------------------------------
# OPTIONAL: Safety idle at 07:00 if SoC < 75 (keeps 07:00–08:00 clean/idle)
# ----------------------------------------------------------------------------
- id: solarflow_grid_zero_idle_if_low_soc_0700
  alias: "SolarFlow – Idle at 07:00 if SoC < 75"
  mode: single
  trigger:
    - platform: time
      at: "07:00:05"
  condition:
    - condition: numeric_state
      entity_id: sensor.solarflow_800_pro_electric_level
      below: 75
  action:
    - service: number.set_value
      target:
        entity_id:
          - number.solarflow_800_pro_output_limit
          - number.solarflow_800_pro_input_limit
      data:
        value: 0
      continue_on_error: false

    - service: input_number.set_value
      target:
        entity_id:
          - input_number.solarflow_discharge_last
          - input_number.solarflow_charge_last
      data:
        value: 0

# ----------------------------------------------------------------------------
# HARD STOP at 03:00 (no matter what)
# ----------------------------------------------------------------------------
- id: solarflow_grid_zero_hard_stop_0200
  alias: "SolarFlow – Grid-Zero Hard Stop (03:00)"
  trigger:
    - platform: time
      at: "03:00:00"
  condition: []
  action:
    - service: select.select_option
      target:
        entity_id: select.solarflow_800_pro_ac_mode
      data:
        option: "output"

    - service: number.set_value
      target:
        entity_id:
          - number.solarflow_800_pro_output_limit
          - number.solarflow_800_pro_input_limit
      data:
        value: 0
      continue_on_error: false

    - service: input_number.set_value
      target:
        entity_id:
          - input_number.solarflow_discharge_last
          - input_number.solarflow_charge_last
      data:
        value: 0
