# ============================================================================
# NIGHT: Charge SolarFlow from grid when today's PV forecast is low
# Uses Forecast.Solar sensor.energy_production_today (kWh)
#
# Window: 02:00â€“08:00
# - If PV forecast < 5 kWh AND SoC low -> charge at 800 W
# - Emergency (helper-based + latched):
#     start when soc <= input_number.solarflow_emergency_soc
#     keep charging until soc >= input_number.solarflow_emergency_stop_soc
# ============================================================================

- id: solarflow_night_charge_low_pv_forecast
  alias: "SolarFlow â€“ Charge at 02:00 if Today's PV Forecast < 5kWh (02:00â€“08:00)"
  description: >
    Charge SolarFlow from the grid at 800 W during 02:00â€“08:00 when today's PV
    estimate is low (<5 kWh). Emergency charge uses helper thresholds + hysteresis.
  mode: restart

  trigger:
    - platform: time_pattern
      minutes: "/10"
      id: periodic_check

    - platform: state
      entity_id: sensor.solarflow_800_pro_electric_level
      for: "00:00:20"
      id: soc_change

    - platform: time
      at: "02:00:00"
      id: window_start

    - platform: time
      at: "08:00:00"
      id: window_end_check

    - platform: homeassistant
      event: start
      id: ha_startup

  condition:
    - condition: time
      after: "02:00:00"
      before: "08:00:00"

    - condition: template
      value_template: >
        {{ states('sensor.solarflow_800_pro_electric_level')
           not in ['unknown','unavailable'] }}

    - condition: template
      value_template: >
        {{ states('number.solarflow_800_pro_output_limit')
             not in ['unknown','unavailable']
           and
           states('number.solarflow_800_pro_input_limit')
             not in ['unknown','unavailable'] }}

  action:
    - variables:
        soc: "{{ states('sensor.solarflow_800_pro_electric_level') | float(0) }}"
        last_charge: "{{ states('input_number.solarflow_charge_last') | float(0) | int }}"
        charge_power: 800
        low_pv_soc_limit: "{{ states('input_number.solarflow_low_pv_soc_limit') | float(45) }}"

        # Use today's forecast (because at 02:00 it's already "today")
        pv_today_kwh: "{{ states('sensor.energy_production_today') | float(0) }}"
        pv_threshold_kwh: "{{ states('input_number.solarflow_pv_threshold_kwh') | float(5) }}"

        pv_forecast_available: >-
          {{ states('sensor.energy_production_today')
             not in ['unknown','unavailable','none',''] }}

        # Emergency thresholds from helpers
        emergency_start_soc: "{{ states('input_number.solarflow_emergency_soc') | float(20) }}"
        emergency_stop_soc: "{{ states('input_number.solarflow_emergency_stop_soc') | float(45) }}"

        # Charge because today's PV is low
        should_charge_low_pv: >-
          {{ pv_forecast_available
            and (pv_today_kwh < pv_threshold_kwh)
            and soc < 80
            and (soc < low_pv_soc_limit or last_charge > 0) }}


        # Emergency hysteresis:
        # - Start if soc <= emergency_start_soc
        # - Keep charging if already charging (last_charge > 0)
        # - Stop only once soc >= emergency_stop_soc
        should_charge_emergency: >-
          {{ (soc < emergency_stop_soc)
             and (soc <= emergency_start_soc or last_charge > 0) }}

    - choose:

        # 1) Charge because today's PV forecast is low
        - conditions:
            - condition: template
              value_template: "{{ should_charge_low_pv }}"
          sequence:
            - service: select.select_option
              target:
                entity_id: select.solarflow_800_pro_ac_mode
              data:
                option: "input"

            - service: number.set_value
              target:
                entity_id: number.solarflow_800_pro_output_limit
              data:
                value: 0

            - service: number.set_value
              target:
                entity_id: number.solarflow_800_pro_input_limit
              data:
                value: "{{ charge_power }}"

            - service: input_number.set_value
              target:
                entity_id: input_number.solarflow_discharge_last
              data:
                value: 0

            - service: input_number.set_value
              target:
                entity_id: input_number.solarflow_charge_last
              data:
                value: "{{ charge_power }}"

            - service: system_log.write
              data:
                level: debug
                logger: solarflow_grid_control
                message: >
                  ðŸŒ™ 02:00 CHARGE (LOW PV TODAY): {{ charge_power }}W | soc={{ soc }}%
                  | pv_today={{ pv_today_kwh }}kWh | threshold={{ pv_threshold_kwh }}kWh

        # 2) Emergency charge (helper-based, latched)
        - conditions:
            - condition: template
              value_template: "{{ should_charge_emergency }}"
          sequence:
            - service: select.select_option
              target:
                entity_id: select.solarflow_800_pro_ac_mode
              data:
                option: "input"

            - service: number.set_value
              target:
                entity_id: number.solarflow_800_pro_output_limit
              data:
                value: 0

            - service: number.set_value
              target:
                entity_id: number.solarflow_800_pro_input_limit
              data:
                value: "{{ charge_power }}"

            - service: input_number.set_value
              target:
                entity_id: input_number.solarflow_discharge_last
              data:
                value: 0

            - service: input_number.set_value
              target:
                entity_id: input_number.solarflow_charge_last
              data:
                value: "{{ charge_power }}"

            - wait_template: >
                {{ states('sensor.solarflow_800_pro_electric_level') | float(0) >= emergency_stop_soc }}
              timeout: "06:00:00"
              continue_on_timeout: true

            - service: select.select_option
              target:
                entity_id: select.solarflow_800_pro_ac_mode
              data:
                option: "output"

            - service: number.set_value
              target:
                entity_id:
                  - number.solarflow_800_pro_output_limit
                  - number.solarflow_800_pro_input_limit
              data:
                value: 0

            - service: input_number.set_value
              target:
                entity_id:
                  - input_number.solarflow_discharge_last
                  - input_number.solarflow_charge_last
              data:
                value: 0

            - service: system_log.write
              data:
                level: debug
                logger: solarflow_grid_control
                message: >
                  ðŸŒ™ EMERGENCY CHARGE: stopped at soc={{
                    states('sensor.solarflow_800_pro_electric_level')
                  }}% (target {{ emergency_stop_soc }}%)

      # 3) Default: ensure we are idle if we were charging before
      default:
        - condition: template
          value_template: "{{ (last_charge | int) != 0 }}"
        - service: select.select_option
          target:
            entity_id: select.solarflow_800_pro_ac_mode
          data:
            option: "output"
        - service: number.set_value
          target:
            entity_id:
              - number.solarflow_800_pro_output_limit
              - number.solarflow_800_pro_input_limit
          data:
            value: 0
        - service: input_number.set_value
          target:
            entity_id:
              - input_number.solarflow_discharge_last
              - input_number.solarflow_charge_last
          data:
            value: 0
        - service: system_log.write
          data:
            level: debug
            logger: solarflow_grid_control
            message: >
              ðŸ›‘ WINDOW STOP: soc={{ soc }}% (conditions not met)
